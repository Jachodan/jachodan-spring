<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.jaegokeeper.hwan.mapper.RequestMapper">

    <insert id="insertRequest"
            parameterType="com.jaegokeeper.hwan.domain.Request"
            useGeneratedKeys="true"
            keyProperty="requestId">

        INSERT INTO request(
                            stock_id,
                            alba_id,
                            request_amount,
                            request_date,
                            request_type,
                            request_status
        )
        VALUES (
                #{stockId},
                #{albaId},
                #{requestAmount},
                #{requestDate},
                #{requestType},
                #{requestStatus}
               )
    </insert>

    <select id="findRequestList" resultType="com.jaegokeeper.hwan.dto.RequestListDTO">
        SELECT
            r.request_id AS requestId,
            r.request_type AS requestType,
            i.item_name AS itemName,
            r.request_amount AS requestAmount,
            r.request_date AS requestDate,
            a.alba_name AS albaName,
            r.request_status AS requestStatus,
            r.created_at AS createdAt
        FROM request r
        JOIN stock s
        ON r.stock_id = s.stock_id
        JOIN item i
        ON s.item_id = i.item_id
        JOIN alba a
        ON r.alba_id = a.alba_id

        <where>
            s.store_id = #{storeId}
        AND r.del_yn = b'0'

        <if test="requestType != null">
            AND r.request_type = #{requestType}
        </if>

        <if test="requestStatus != null">
            AND r.request_status = #{requestStatus}
        </if>

        </where>

        ORDER BY r.created_at DESC
        LIMIT #{size} OFFSET #{offset}
    </select>

    <select id="countRequestList" resultType="long">
        SELECT COUNT(*)
        FROM request r
        JOIN stock s ON r.stock_id = s.stock_id
        <where>
            s.store_id = #{storeId}
        AND r.del_yn = b'0'

        <if test="requestType != null">
            AND r.request_type = #{requestType}
        </if>
        <if test="requestStatus != null">
            AND r.request_status = #{requestStatus}
        </if>
        </where>
    </select>


</mapper>