<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.jaegokeeper.auth.mapper.UserAuthMapper">

    <select id="findByProviderUid" parameterType="com.jaegokeeper.auth.dto.UidDTO" resultType="com.jaegokeeper.auth.dto.LoginTarget">
        SELECT
            u.user_id AS userId,
            u.user_name AS userName,
            u.is_active AS isActive,
            s.store_id AS storeId
        FROM uid d
            JOIN user u ON u.user_id = d.user_id
            LEFT JOIN store s ON s.user_id = u.user_id
        WHERE d.provider = #{provider}
          AND d.provider_uid = #{providerUid}
        LIMIT 1
    </select>

    <select id="findByUserIdForSession" parameterType="java.lang.Integer" resultType="com.jaegokeeper.auth.dto.LoginTarget">
        SELECT
            u.user_id AS userId,
            u.user_name AS userName,
            s.store_id AS storeId,
            (
              SELECT a.provider
              FROM uid a
              WHERE a.user_id = u.user_id
              ORDER BY a.auth_id DESC
              LIMIT 1
            ) AS provider
        FROM user u
            LEFT JOIN store s ON s.user_id = u.user_id
        WHERE u.user_id = #{userId} AND u.is_active = 1
        LIMIT 1
    </select>

    <insert id="insertUser"
            parameterType="com.jaegokeeper.auth.dto.UserDTO"
            useGeneratedKeys="true"
            keyProperty="userId">
        INSERT INTO user (
            user_name,
            pass_hash,
            user_mail,
            user_phone
        ) VALUES (
            #{userName},
            #{passHash},
            #{userMail},
            #{userPhone}
        )
    </insert>

    <insert id="insertAuth"
            parameterType="com.jaegokeeper.auth.dto.UidDTO"
            useGeneratedKeys="true"
            keyProperty="authId">
        INSERT INTO uid (user_id, provider, provider_uid, pass_hash)
        VALUES (#{userId}, #{provider}, #{providerUid}, #{passHash})
    </insert>


    <insert id="insertTicket" parameterType="com.jaegokeeper.auth.dto.TicketDTO">
        INSERT INTO ticket (ticket_key, user_id, redirect_url, expires_at, used_yn)
        VALUES (#{ticketKey}, #{userId}, #{redirectUrl}, #{expiresAt}, 'N')
    </insert>

    <select id="findValidTicket" parameterType="java.lang.String" resultType="com.jaegokeeper.auth.dto.TicketDTO">
        SELECT ticket_key AS ticketKey,
               user_id AS userId,
               redirect_url AS redirectUrl,
               expires_at AS expiresAt,
               used_yn AS usedYn
        FROM ticket
        WHERE ticket_key = #{ticketKey}
          AND used_yn = 'N'
          AND expires_at > NOW()
        LIMIT 1
    </select>

    <update id="markUsed" parameterType="java.lang.String">
        UPDATE ticket
        SET used_yn = 'Y'
        WHERE ticket_key = #{ticketKey}
          AND used_yn = 'N'
    </update>

    <select id="findUserByEmail" resultType="com.jaegokeeper.auth.dto.UserDTO">
        SELECT
            user_id as userId,
            pass_hash as passHash,
            user_name as userName,
            user_mail as userMail,
            user_phone as userPhone,
            is_active as isActive
        FROM user
        WHERE user_mail = #{email}
        LIMIT 1
    </select>

    <select id="findUserById" parameterType="java.lang.Integer" resultType="com.jaegokeeper.auth.dto.UserDTO">
        SELECT
            user_id as userId,
            pass_hash as passHash,
            user_name as userName,
            user_mail as userMail,
            user_phone as userPhone,
            is_active as isActive
        FROM user
        WHERE user_id = #{userId}
        LIMIT 1
    </select>

</mapper>